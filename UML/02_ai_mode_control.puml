@startuml AI Mode - Adaptive Heating Control
title AI Mode - Autonomous Temperature Optimization

actor User
participant "Web Browser\n(UI)" as UI
participant "heatpump-service\n(FastAPI)" as API
participant "adaptive_controller" as AI
participant "heating_curve" as Curve
participant "modbus_client" as Modbus
participant "Heat Pump\n(Modbus TCP)" as HeatPump
participant "Thermostat API\n(iot-api:8000)" as Thermostat

== User Enables AI Mode ==
User -> UI: Toggles AI Mode switch\n(Manual → AI)
UI -> API: POST /ai-mode\n{"enabled": true}
API -> AI: enabled = True
AI --> API: Status updated
API --> UI: 200 OK\n{"status": "success", "ai_mode": true}
UI -> UI: Disable temperature slider\nShow "AI Mode Active"
UI --> User: Visual feedback (green text)

== AI Mode Control Loop (Every 30 seconds) ==
loop Every 30 seconds (while AI Mode enabled)

    AI -> Modbus: get_cached_status()
    Modbus --> AI: {outdoor_temperature: 5.0}

    AI -> Thermostat: GET /api/v1/thermostat/status

    alt Thermostat API Available
        Thermostat --> AI: 200 OK\n{"config": {"target_temp": 21.5}}
        AI -> AI: target_room_temp = 21.5°C
    else Thermostat API Unavailable
        Thermostat --> AI: Connection timeout/error
        AI -> AI: Use fallback:\ntarget_room_temp = 21.0°C\n(from config)
    end

    AI -> Curve: calculate_flow_temp(\n  outdoor_temp=5.0,\n  target_room_temp=21.5)

    Curve -> Curve: Select heating curve\n(Comfort Mode: 21-23°C)

    Curve -> Curve: Find outdoor range\n(0-10°C → 40°C)

    Curve -> Curve: Apply safety limits\n(min: 30°C, max: 50°C)

    Curve -> Curve: Round to whole number\n(40°C)

    Curve --> AI: optimal_flow_temp = 40.0°C

    AI -> Modbus: get_cached_status()
    Modbus --> AI: {target_temperature: 38.0}

    alt Temperature Adjustment Needed (diff ≥ 2°C)
        AI -> AI: temp_diff = |38 - 40| = 2°C\n≥ threshold (2°C)

        opt Heat pump is OFF
            AI -> Modbus: set_power(True)
            Modbus -> HeatPump: Write Coil 00001 (ON)
            HeatPump --> Modbus: Success
            AI -> AI: Wait 2 seconds\n(power-on delay)
        end

        AI -> Modbus: set_target_temperature(40.0)
        Modbus -> HeatPump: Write Holding Register 40003\n(value: 400)
        HeatPump --> Modbus: Success
        Modbus --> AI: True

        AI -> AI: Log: "AI Mode: Adjusted flow\ntemperature 38°C → 40°C"
    else Temperature OK (diff < 2°C)
        AI -> AI: Log: "No adjustment needed\n(diff < 2°C threshold)"
    end

    alt Outdoor Temp ≥ Cutoff (18°C)
        AI -> AI: optimal_flow_temp = None
        AI -> Modbus: set_power(False)
        Modbus -> HeatPump: Write Coil 00001 (OFF)
        HeatPump --> Modbus: Success
        AI -> AI: Log: "Outdoor temp ≥18°C\nTurning heat pump OFF"
    end

end

== User Monitors AI Mode Status ==
User -> UI: Views dashboard
UI -> API: GET /ai-mode
API -> AI: get_status()
AI --> API: {\n  enabled: true,\n  last_update: "2025-10-10T17:20:09",\n  outdoor_temperature: 5.0,\n  target_room_temperature: 21.5,\n  calculated_flow_temperature: 40.0,\n  heating_curve: "Comfort Mode"\n}
API --> UI: 200 OK
UI --> User: Display AI status info

note right of AI
  AI Mode runs autonomously
  in background asyncio task.

  Continues regardless of
  whether user is viewing UI.

  Falls back to default temp
  if thermostat unavailable.
end note

@enduml
